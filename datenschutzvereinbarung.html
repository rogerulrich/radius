<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Datenschutzerklärung – RADIUS Praxis für Ernährung GmbH</title>

  <style>
    :root{
      --text:#111;
      --muted:#555;
      --border:#e6e6e6;
      --bg:#fff;
      --card:#fafafa;
      --max:920px;
      --danger:#c62828;
      --dangerBg:#ffebee;
    }
    html,body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.55}
    body{margin:0}

    header{border-bottom:1px solid var(--border);background:var(--card)}
    .wrap{max-width:var(--max);margin:0 auto;padding:24px 16px}
    h1{font-size:1.9rem;margin:0 0 6px}
    .meta{color:var(--muted);font-size:.95rem;margin:0}

    main{padding:24px 0 48px}
    section{margin:22px 0}
    h2{font-size:1.25rem;margin:0 0 10px}
    p{margin:0 0 10px}
    ul{margin:8px 0 0 18px}
    li{margin:6px 0}
    .box{border:1px solid var(--border);border-radius:12px;padding:14px 16px;background:#fff}

    .signature{
      margin-top:14px;
      border-top:1px dashed var(--border);
      padding-top:14px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
    }
    .line{display:grid;gap:8px}
    .line span{color:var(--muted);font-size:.9rem}

    .inputlike{
      height:44px;border:1px solid var(--border);border-radius:10px;background:#fff;
      display:flex;align-items:center;padding:0 12px;font-weight:600;
    }

    .field{display:grid;gap:8px;margin-top:10px;}
    .field label{color:var(--muted);font-size:.9rem}
    .textinput{
      height:44px;border:1px solid var(--border);border-radius:10px;background:#fff;
      padding:0 12px;font-weight:600;font-size:1rem;
    }
    .textinput.required{
      border-color: var(--danger);
      box-shadow: 0 0 0 3px rgba(198,40,40,.12);
      background: var(--dangerBg);
    }

    .sigbox{
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
      overflow:hidden;
      position:relative;
      height:140px;
    }
    canvas#sigCanvas{width:100%;height:140px;touch-action:none;display:block}

    .sig-actions{
      display:flex;
      gap:8px;
      margin-top:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .actions-bottom{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:16px;
      padding-top:14px;
      border-top:1px solid var(--border);
    }
    button{
      border:1px solid var(--border);
      background:#fff;
      border-radius:10px;
      padding:10px 12px;
      font-weight:600;
      cursor:pointer;
    }
    button:disabled{opacity:.55;cursor:not-allowed}
    .hint{color:var(--muted);font-size:.95rem}
    .hint.danger{color:var(--danger);font-weight:700}

    /* Pflichtfeld-Markierung Unterschrift */
    .sigbox.required{
      border-color: var(--danger);
      box-shadow: 0 0 0 3px rgba(198,40,40,.12);
      background: var(--dangerBg);
    }

    /* Elemente während PDF-Export ausblenden (aber im Browser sichtbar) */
    body.pdf-exporting [data-hide-in-pdf="true"]{
      display:none !important;
    }

    /* Print: ebenfalls ausblenden */
    @media print{
      [data-hide-in-pdf="true"]{display:none !important;}
      header{background:#fff}
      .box,body{background:#fff}
      a{color:inherit;text-decoration:none}
    }
  </style>

  <!-- PDF Export Libraries (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>

<body>
  <!-- Alles, was in die PDF soll, liegt in #pdfRoot (inkl. Titel/Header) -->
  <div id="pdfRoot">
    <header>
      <div class="wrap">
        <h1>Datenschutzerklärung</h1>
        <p class="meta">RADIUS Praxis für Ernährung GmbH · Version: 10/25</p>
      </div>
    </header>

    <main class="wrap">
      <section class="box">
        <h2>1. Zweck</h2>
        <p>
          Die vorliegende Datenschutzerklärung beschreibt den Umfang, den Zweck und die Art und Weise,
          wie die RADIUS Praxis für Ernährung GmbH Personendaten bearbeitet.
        </p>
      </section>

      <section class="box">
        <h2>2. Bearbeitung von Personendaten</h2>
        <p>Die RADIUS Praxis für Ernährung führt eine Kundendokumentation. Wir erfassen und bearbeiten folgende Kategorien der Personendaten:</p>
        <ul>
          <li>Gesundheitsdaten (werden bei Bedarf bei Zuweisenden / Spitälern angefordert)</li>
          <li>
            Administrative Daten zum Zweck der Rechnungsstellung, Buchführung, Terminvereinbarung
            (Vorname, Name, Adresse, Mailadresse, Telefonnummer, Krankenkasse, Versicherungsklasse,
            Geburtsdatum, AHV Nummer, zuweisende Ärztin/Arzt)
          </li>
          <li>Wir bearbeiten Ihre Personendaten ausschliesslich zum Zweck der Vertragserfüllung.</li>
        </ul>
      </section>

      <section class="box">
        <h2>3. Weitergabe der Personendaten</h2>
        <p>
          Die Personendaten werden in elektronischer Form gespeichert. Papierdokumente mit Kundendaten werden
          in der Ernährungsberatung des PFGM Medicalcenters respektive des ASANA Spitals Menziken aufbewahrt
          und sind unter Verschluss. Für die Führung, Verwaltung und Sicherung dieser Daten ist die RADIUS Praxis
          für Ernährung GmbH verantwortlich. Zum Schutz der Kundendaten werden angemessene technische und
          organisatorische Massnahmen getroffen.
        </p>
        <p>
          Unsere Rechnungsstellung erfolgt über das Rechnungswesen des PFGM Medicalcenters in Wauwil (LU).
          Im Falle eines Inkassos werden die Daten an eine für das Inkasso zuständige Institution übermittelt.
          Wir stellen vertraglich sicher, dass externe Dienstleister angemessene Massnahmen betreffend Sicherheit
          und Schutz der Personendaten treffen und die Daten nur zu dem Zweck bearbeiten, wie wir das selbst tun dürften.
        </p>
        <p>
          Mitarbeitende der RADIUS Praxis für Ernährung GmbH unterstehen einer beruflichen Schweigepflicht.
          Einsicht in Personendaten erhalten im Rahmen der gesetzlichen Bestimmungen grundsätzlich Vertrauensärztinnen
          und Vertrauensärzte von Versicherern und in bestimmten Einzelfällen die vom Gesetz bestimmten Behörden.
          Wenn Daten weitergegeben werden, müssen Sie darüber informiert werden.
        </p>
        <p>
          Ausgenommen ist die Datenweitergabe an die Kranken- und Unfallversicherer, Zuweisende im Rahmen
          standardisierter Melde- und Abrechnungsinstrumente sowie im Rahmen der Amtshilfe.
        </p>
        <p>
          Weitere Personen, Behörden und Institutionen werden Kundendaten nur mitgeteilt, wenn Sie ausdrücklich
          schriftlich zustimmen oder wenn das Departement Gesundheit und Soziales die RADIUS Praxis für Ernährung GmbH
          von der Schweigepflicht befreit. Dies gilt auch für Familienangehörige (einschliesslich Ehepartner und Kinder)
          und andere Personen, die im gleichen Haushalt leben.
        </p>
      </section>

      <section class="box">
        <h2>4. Aufbewahrung der Daten</h2>
        <p>
          Die Personendaten werden so lange aufbewahrt, wie es die gesetzlichen und vertraglichen Aufbewahrungsfristen
          verlangen. Die RADIUS Praxis für Ernährung GmbH ist verpflichtet, die Personendaten während mind. 10 Jahren
          aufzubewahren. Aus Sicherheitsgründen werden die Daten in der RADIUS Praxis für Ernährung GmbH 20 Jahre
          aufbewahrt. Nach Ablauf dieser Zeitspanne werden die Personendaten gelöscht oder anonymisiert.
        </p>
      </section>

      <section class="box">
        <h2>5. Betroffenenrechte</h2>
        <p>
          Sie haben als betroffene Person das Recht auf Auskunft, welche Daten wir über Sie bearbeiten. Sie haben zudem
          das Recht, die Berichtigung, Löschung oder Einschränkung der Bearbeitung Ihrer Daten zu verlangen, sowie das
          Recht auf Datenübertragbarkeit. Diese Rechte bestehen, sofern keine gesetzlichen Aufbewahrungspflichten oder
          eigene berechtigte Interessen dem Begehren entgegenstehen.
        </p>
        <p>
          Sie sind jederzeit berechtigt, eine einmal erteilte Einwilligung in eine Datenbearbeitung zu widerrufen.
          Ihre Rechte können Sie geltend machen, indem Sie sich an die Kontaktadresse wenden.
        </p>
      </section>

      <section class="box">
        <h2>6. Kontaktangaben</h2>
        <p>
          RADIUS Praxis für Ernährung GmbH<br />
          Glasiweg 3a, 6242 Wauwil<br />
          <a href="mailto:radius@hin.ch">radius@hin.ch</a>
        </p>
      </section>

      <section class="box">
        <h2>7. Änderungen</h2>
        <p>
          Wir können diese Datenschutzbestimmungen jederzeit anpassen. Es gilt die jeweils aktuelle, auf unserer Website
          publizierte Fassung.
        </p>
      </section>

      <section class="box">
        <h2>Erlaubniserteilung</h2>
        <p>
          Ich bestätige, das Merkblatt Datenschutzerklärung der RADIUS Praxis für Ernährung GmbH zu den Personendaten
          gelesen zu haben und über meine Datenschutzrechte aufgeklärt worden zu sein.
        </p>
        <p>
          Ich ermächtige die RADIUS Praxis für Ernährung GmbH sowie ihre externen Dienstleister, während des laufenden
          Beratungszeitraumes, längstens jedoch aber für fünf Jahre Personendaten an Zuweisende (z.B. für Rückmeldungen
          zum Beratungsverlauf) sowie andere externe Dienstleister (z.B. zwecks Rechnungsstellung) weiterzugeben.
        </p>
        <p>
          Ich bestätige ebenfalls, dass die RADIUS Praxis für Ernährung GmbH meine medizinischen Akten von Spitälern und
          weiteren behandelnden Ärztinnen und Ärzten anfordern darf.
        </p>
        <p>
          Ich wurde informiert, dass im Verhinderungs- oder Krankheitsfall vereinbarte Termine mindestens 24h vorher
          abgesagt werden müssen. Ansonsten wird eine versäumte Konsultation Ernährungsberatung in der Höhe von
          40 CHF privat in Rechnung gestellt.
        </p>

        <!-- Patientenname + Geburtsdatum (Pflicht) -->
        <div class="field" style="margin-top:10px;">
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div style="display:grid; gap:8px;">
              <label for="patientName">Patientenname <span style="color:#c62828">*</span></label>
              <input
                id="patientName"
                class="textinput"
                type="text"
                placeholder="z.B. Max Muster"
                autocomplete="name"
                required
              />
              <div id="nameError" class="hint danger" style="display:none;">
                Bitte Patientenname ausfüllen.
              </div>
            </div>

            <div style="display:grid; gap:8px;">
              <label for="birthDate">Geburtsdatum <span style="color:#c62828">*</span></label>
              <input
                id="birthDate"
                class="textinput"
                type="date"
                required
              />
              <div id="birthError" class="hint danger" style="display:none;">
                Bitte Geburtsdatum ausfüllen.
              </div>
            </div>
          </div>

          <!-- Im PDF sichtbar -->
          <p class="meta" style="margin-top:10px;">
            Patient: <strong id="patientNamePrint">—</strong> · Geburtsdatum: <strong id="birthDatePrint">—</strong>
          </p>
        </div>

        <div class="signature">
          <div class="line">
            <span>Datum</span>
            <div class="inputlike" id="autoDate" aria-label="Datum"></div>

            <span>Zeitstempel (Lokal / UTC)</span>
            <div class="inputlike" id="signTimestamp" aria-label="Zeitstempel">—</div>
          </div>

          <div class="line">
            <span>Unterschrift (Pflichtfeld)</span>
            <div class="sigbox required" id="sigBox" aria-label="Unterschrift">
              <canvas id="sigCanvas"></canvas>
            </div>

            <!-- Aktionen (nicht im PDF) -->
            <div class="sig-actions" data-hide-in-pdf="true">
              <button id="btnClearSig" type="button">Unterschrift löschen</button>
              <span id="sigHint" class="hint danger">Bitte Patientenname und Geburtsdatum ausfüllen und unterschreiben, um das PDF herunterladen zu können.</span>
            </div>
          </div>
        </div>

        <!-- Buttons ganz unten (NICHT im PDF) -->
        <div class="actions-bottom" data-hide-in-pdf="true">
          <button id="btnDownload" disabled>Als PDF herunterladen</button>
          <button id="btnPrint" type="button" onclick="window.print()">Drucken</button>
          <span id="status" class="meta" aria-live="polite"></span>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ---------- Helpers ----------
    const pad2 = (n) => String(n).padStart(2, '0');
    const safeFilePart = (s) =>
      (s || '')
        .trim()
        .replace(/\s+/g, '_')
        .replace(/[^\wäöüÄÖÜß-]/g, '')
        .slice(0, 60) || 'Patient';

    function formatLocalCH(d) {
      const date = `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()}`;
      const time = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
      return `${date} ${time}`;
    }
    function formatUTC(d) {
      const y = d.getUTCFullYear();
      const m = pad2(d.getUTCMonth()+1);
      const day = pad2(d.getUTCDate());
      const hh = pad2(d.getUTCHours());
      const mm = pad2(d.getUTCMinutes());
      return `${y}-${m}-${day} ${hh}:${mm} UTC`;
    }
    function isoDate(d) {
      const y = d.getFullYear();
      const m = pad2(d.getMonth()+1);
      const day = pad2(d.getDate());
      return `${y}-${m}-${day}`;
    }
    function formatBirthForPrint(iso) {
      const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(iso || "");
      if (!m) return "—";
      return `${m[3]}.${m[2]}.${m[1]}`;
    }

    // ---------- Auto-Date (nur Datum) ----------
    (function setAutoDate() {
      const el = document.getElementById('autoDate');
      const now = new Date();
      el.textContent = `${pad2(now.getDate())}.${pad2(now.getMonth()+1)}.${now.getFullYear()}`;
    })();

    // ---------- Elements ----------
    const canvas = document.getElementById('sigCanvas');
    const sigBox = document.getElementById('sigBox');
    const btnDownload = document.getElementById('btnDownload');
    const btnClearSig = document.getElementById('btnClearSig');
    const sigHint = document.getElementById('sigHint');
    const statusEl = document.getElementById('status');
    const timestampEl = document.getElementById('signTimestamp');

    const nameInput = document.getElementById('patientName');
    const nameError = document.getElementById('nameError');
    const patientNamePrint = document.getElementById('patientNamePrint');

    const birthInput = document.getElementById('birthDate');
    const birthError = document.getElementById('birthError');
    const birthDatePrint = document.getElementById('birthDatePrint');

    const ctx = canvas.getContext('2d');

    let drawing = false;
    let last = null;
    let hasSignature = false;
    let signatureTimestamp = null;

    // ---------- Required: Name + Birthdate ----------
    function isNameValid() {
      return nameInput.value.trim().length >= 2;
    }
    function isBirthValid() {
      return birthInput.value && birthInput.value.trim().length > 0;
    }

    function syncPatientPrint() {
      const v = nameInput.value.trim();
      patientNamePrint.textContent = v.length ? v : '—';
    }
    function syncBirthPrint() {
      birthDatePrint.textContent = isBirthValid() ? formatBirthForPrint(birthInput.value) : '—';
    }

    function updateNameUI() {
      const ok = isNameValid();
      nameInput.classList.toggle('required', !ok);
      nameError.style.display = ok ? 'none' : 'block';
    }
    function updateBirthUI() {
      const ok = isBirthValid();
      birthInput.classList.toggle('required', !ok);
      birthError.style.display = ok ? 'none' : 'block';
    }

    // ---------- Signature ----------
    function setTimestampIfNeeded() {
      if (signatureTimestamp) return;
      signatureTimestamp = new Date();
      timestampEl.textContent = `${formatLocalCH(signatureTimestamp)} (Lokal) / ${formatUTC(signatureTimestamp)}`;
    }

    function updateDownloadState() {
      updateNameUI();
      updateBirthUI();
      syncPatientPrint();
      syncBirthPrint();

      const ok = hasSignature && isNameValid() && isBirthValid();
      btnDownload.disabled = !ok;

      if (!hasSignature && (!isNameValid() || !isBirthValid())) {
        sigHint.textContent = 'Bitte Patientenname und Geburtsdatum ausfüllen und unterschreiben, um das PDF herunterladen zu können.';
        sigHint.classList.add('danger');
      } else if (!isNameValid() || !isBirthValid()) {
        sigHint.textContent = 'Bitte Patientenname und Geburtsdatum ausfüllen, um das PDF herunterzuladen.';
        sigHint.classList.add('danger');
      } else if (!hasSignature) {
        sigHint.textContent = 'Bitte unterschreiben, um das PDF herunterladen zu können.';
        sigHint.classList.add('danger');
      } else {
        sigHint.textContent = 'Alle Pflichtfelder erfüllt. PDF-Download ist freigeschaltet.';
        sigHint.classList.remove('danger');
      }
    }

    function setSignatureState(signed) {
      hasSignature = signed;
      sigBox.classList.toggle('required', !signed);
      if (!signed) {
        timestampEl.textContent = '—';
        signatureTimestamp = null;
      }
      updateDownloadState();
    }

    // ---------- Canvas sizing ----------
    function resizeCanvas() {
      const rect = sigBox.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;

      canvas.width = Math.max(1, Math.floor(rect.width * dpr));
      canvas.height = Math.max(1, Math.floor(rect.height * dpr));

      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';

      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // ---------- Drawing ----------
    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      return { x: e.clientX - rect.left, y: e.clientY - rect.top };
    }

    canvas.addEventListener('pointerdown', (e) => {
      drawing = true;
      canvas.setPointerCapture(e.pointerId);
      last = getPos(e);
    });

    canvas.addEventListener('pointermove', (e) => {
      if (!drawing) return;
      const pos = getPos(e);

      ctx.beginPath();
      ctx.moveTo(last.x, last.y);
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();

      last = pos;

      setTimestampIfNeeded();
      if (!hasSignature) setSignatureState(true);
    });

    function endDraw(e) {
      drawing = false;
      last = null;
      try { canvas.releasePointerCapture(e.pointerId); } catch (_) {}
    }
    canvas.addEventListener('pointerup', endDraw);
    canvas.addEventListener('pointercancel', endDraw);
    canvas.addEventListener('pointerleave', () => { drawing = false; last = null; });

    btnClearSig.addEventListener('click', () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      setSignatureState(false);
    });

    // Live validation
    nameInput.addEventListener('input', updateDownloadState);
    birthInput.addEventListener('input', updateDownloadState);
    birthInput.addEventListener('change', updateDownloadState);

    // Initial state
    setSignatureState(false);
    updateDownloadState();

    // ---------- PDF Export ----------
    btnDownload.addEventListener('click', async () => {
      // Extra-Sicherheit: falls Pflichtfelder fehlen -> highlight + focus
      if (!isNameValid()) {
        updateDownloadState();
        nameInput.focus();
        return;
      }
      if (!isBirthValid()) {
        updateDownloadState();
        birthInput.focus();
        return;
      }
      if (!hasSignature) {
        updateDownloadState();
        return;
      }

      btnDownload.disabled = true;
      statusEl.textContent = 'Erstelle PDF…';
      document.body.classList.add('pdf-exporting');

      try {
        const root = document.getElementById('pdfRoot');

        // 1) Haupt-PDF (Screenshot von Header+Inhalt)
        const shot = await html2canvas(root, {
          scale: 2,
          useCORS: true,
          backgroundColor: '#ffffff',
          scrollX: 0,
          scrollY: -window.scrollY
        });

        const imgData = shot.toDataURL('image/jpeg', 0.92);

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');

        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();

        const imgProps = pdf.getImageProperties(imgData);
        const imgWidth = pageWidth;
        const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft > 0) {
          position = position - pageHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }

        // 2) Zusätzliche Seite: Unterschrift separat
        const sigDataUrl = canvas.toDataURL('image/png');

        pdf.addPage();
        pdf.setFontSize(16);
        pdf.text('Unterschrift (separat)', 14, 18);

        const patient = safeFilePart(nameInput.value);
        const birth = formatBirthForPrint(birthInput.value);
        const ts = signatureTimestamp ? signatureTimestamp : new Date();

        pdf.setFontSize(11);
        pdf.text(`Patient: ${patient}`, 14, 28);
        pdf.text(`Geburtsdatum: ${birth}`, 14, 34);
        pdf.text(`Zeitstempel: ${formatLocalCH(ts)} (Lokal) / ${formatUTC(ts)}`, 14, 40);

        const sigImgProps = pdf.getImageProperties(sigDataUrl);
        const maxW = pageWidth - 28;
        const maxH = pageHeight - 70;

        let w = maxW;
        let h = (sigImgProps.height * w) / sigImgProps.width;
        if (h > maxH) {
          h = maxH;
          w = (sigImgProps.width * h) / sigImgProps.height;
        }

        const x = (pageWidth - w) / 2;
        const y = 50;

        pdf.addImage(sigDataUrl, 'PNG', x, y, w, h);

        // 3) Dateiname: Patientenname + Geburtsdatum + Datum
        const today = isoDate(new Date());
        const birthIso = (birthInput.value || '').trim(); // YYYY-MM-DD
        pdf.save(`Datenschutzerklaerung_${patient}_${birthIso}_${today}.pdf`);

        statusEl.textContent = '';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'PDF konnte nicht erstellt werden.';
      } finally {
        document.body.classList.remove('pdf-exporting');
        btnDownload.disabled = !(hasSignature && isNameValid() && isBirthValid());
      }
    });
  </script>
</body>
</html>
